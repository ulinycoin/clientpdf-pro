name: ðŸ”¥ GCS Cache Warmer - LocalPDF

on:
  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 6 Ñ‡Ð°ÑÐ¾Ð² (4 Ñ€Ð°Ð·Ð° Ð² Ð´ÐµÐ½ÑŒ)
  schedule:
    # 00:00, 06:00, 12:00, 18:00 UTC
    # ÐžÐ¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð²ÑÐµÑ… Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð¾Ð½
    - cron: '0 */6 * * *'

  # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_dispatch:
    inputs:
      tier:
        description: 'Which tier to warm (tier1, tier2, tier3, tier4, all, auto)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - tier1
          - tier2
          - tier3
          - tier4
          - all

jobs:
  cache-warmer-gcs:
    name: ðŸš€ Warm GCS Cache (113 URLs)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies (optional)
        run: |
          # Cache warmer Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          echo "âœ… No dependencies needed for cache warmer"

      - name: ðŸ”¥ Run GCS Cache Warmer
        run: |
          echo "ðŸš€ Starting GCS Cache Warmer for LocalPDF..."
          echo "ðŸ“… Scheduled run: $(date)"
          echo "ðŸŽ¯ Mode: ${{ github.event.inputs.tier || 'auto' }}"
          echo "ðŸŒ Languages: EN, RU, DE, FR, ES"
          echo "ðŸ“Š Total URLs: 113 pages"
          echo ""

          # Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð¾Ð²Ð¾Ð³Ð¾ GCS cache warmer
          node cache-warmer-gcs.cjs ${{ github.event.inputs.tier || 'auto' }}

        env:
          NODE_ENV: production

      - name: ðŸ“Š Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gcs-cache-warmer-results-${{ github.run_number }}
          path: |
            cache-warmer-gcs-*.log
            cache-warmer-gcs-results-*.json
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ’¬ Notify on Failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'âŒ GCS Cache Warmer failed. Check the workflow logs for details.'
            })

  # ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ ÐºÐµÑˆÐ°
  monitor:
    name: ðŸ“ˆ Monitor GCS Cache Performance
    runs-on: ubuntu-latest
    needs: cache-warmer-gcs
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“ Create Performance Summary
        run: |
          echo "## ðŸ“Š GCS Cache Warmer Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Cache Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** Google Cloud Storage (localpdf-rendertron-cache)" >> $GITHUB_STEP_SUMMARY
          echo "- **TTL:** 24 hours (auto-delete old cache)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total URLs:** 113 pages" >> $GITHUB_STEP_SUMMARY
          echo "- **Languages:** EN, RU, DE, FR, ES" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Size:** ~8 MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Cost:** ~\$0.06/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Expected Performance:" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache HIT:** ~200ms response time" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache MISS:** ~5000ms (first render)" >> $GITHUB_STEP_SUMMARY
          echo "- **Hit Rate:** 99%+ after warming" >> $GITHUB_STEP_SUMMARY
          echo "- **Speed Improvement:** 25x faster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ SEO Benefits:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All 5 languages optimized (EN, RU, DE, FR, ES)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 100% sitemap coverage (113 URLs)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sub-second bot responses" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Better Core Web Vitals for crawlers" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Expected +20-30% organic traffic" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Monitoring:" >> $GITHUB_STEP_SUMMARY
          echo "- [Google Cloud Storage Console](https://console.cloud.google.com/storage/browser/localpdf-rendertron-cache)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Rendertron Logs](https://console.cloud.google.com/run/detail/us-central1/rendertron/logs)" >> $GITHUB_STEP_SUMMARY
          echo "- [Vercel Analytics](https://vercel.com/localpdf/analytics)" >> $GITHUB_STEP_SUMMARY
          echo "- [Google Search Console](https://search.google.com/search-console)" >> $GITHUB_STEP_SUMMARY
