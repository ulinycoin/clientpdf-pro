name: ðŸ”¥ Cache Warmer - LocalPDF

on:
  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 12 Ñ‡Ð°ÑÐ¾Ð²
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº Ð² 6:00 Ð¸ 18:00 UTC ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ
    # Ð­Ñ‚Ð¾ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ cache Ð´Ð¾ ÐµÐ³Ð¾ expiry
    - cron: '0 6,18 * * *'

  # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_dispatch:
    inputs:
      tier:
        description: 'Which tier to warm (tier1, tier2, tier3, all, auto)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - tier1
          - tier2
          - tier3
          - all

jobs:
  cache-warmer:
    name: ðŸš€ Warm Prerender Cache
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --only=production

      - name: ðŸ”¥ Run Cache Warmer
        run: |
          echo "ðŸš€ Starting Cache Warmer for LocalPDF..."
          echo "ðŸ“… Scheduled run: $(date)"
          echo "ðŸŽ¯ Mode: ${{ github.event.inputs.tier || 'auto' }}"
          echo ""

          # Ð—Ð°Ð¿ÑƒÑÐº cache warmer
          node cache-warmer.cjs ${{ github.event.inputs.tier || 'auto' }}

        env:
          # Environment variables (ÐµÑÐ»Ð¸ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±ÑÑ‚ÑÑ)
          NODE_ENV: production

      - name: ðŸ“Š Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cache-warmer-results-${{ github.run_number }}
          path: |
            cache-warmer-*.log
            cache-warmer-results-*.json
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ’¬ Comment on Commit (on failure)
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'âŒ Cache Warmer failed. Check the workflow logs for details.'
            })

  # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ job Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
  monitor:
    name: ðŸ“ˆ Monitor Cache Performance
    runs-on: ubuntu-latest
    needs: cache-warmer
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“Š Run Performance Check
        run: |
          echo "ðŸ“ˆ Running performance monitoring..."
          echo "ðŸ” Checking cache hit rates and response times..."

          # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾: Ð·Ð°Ð¿ÑƒÑÐº Ð½Ð°ÑˆÐµÐ³Ð¾ monitoring ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
          if [ -f "prerender-monitor.cjs" ]; then
            echo "ðŸ§ª Running prerender monitor..."
            node prerender-monitor.cjs quick || echo "âš ï¸ Monitor check had issues"
          fi

          echo "âœ… Monitoring completed"

      - name: ðŸ“ Create Performance Summary
        run: |
          echo "## ðŸ“Š Cache Warmer Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Expected Benefits:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cache refreshed before 3-day expiry" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Bots get 28ms response instead of 3-4s" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ Improved Core Web Vitals for SEO" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Better organic traffic (EN + RU)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor Prerender.io dashboard for cache hits" >> $GITHUB_STEP_SUMMARY
          echo "- Check Google Analytics for traffic improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Review Google Search Console crawl stats" >> $GITHUB_STEP_SUMMARY