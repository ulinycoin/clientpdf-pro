---
// Client-side search component with debounce
---

<div class="search-bar mb-12">
  <div class="relative max-w-xl mx-auto">
    <input
      type="text"
      id="blog-search"
      placeholder="Search articles..."
      class="w-full px-6 py-4 pl-14 text-main bg-glass border border-glass-border rounded-2xl focus:border-accent-light outline-none transition-all placeholder:text-muted/50 shadow-xl"
    />
    <svg
      class="absolute left-5 top-1/2 transform -translate-y-1/2 w-6 h-6 text-muted/60"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
    <div id="search-spinner" class="absolute right-5 top-1/2 transform -translate-y-1/2 hidden">
      <div class="animate-spin h-5 w-5 border-2 border-accent-blue border-t-transparent rounded-full"></div>
    </div>
  </div>

  <div id="search-results" class="mt-8 hidden">
    <div class="text-sm text-muted mb-4 px-2">
      <span id="results-count" class="font-bold text-main">0</span> results found
    </div>
    <div id="results-container" class="grid grid-cols-1 gap-4"></div>
  </div>

  <div id="no-results" class="mt-12 hidden">
    <div class="text-center py-12 px-6 bg-glass border border-glass-border rounded-3xl">
      <p class="text-muted text-lg">
        No articles found. Try different keywords.
      </p>
    </div>
  </div>
</div>

<script>
  // Client-side search with debounce
  let searchIndex: Array<{
    title: string;
    description: string;
    slug: string;
    tags: string[];
    category: string;
  }> = [];

  let debounceTimer: ReturnType<typeof setTimeout>;

  // Load search index
  async function loadSearchIndex() {
    try {
      const response = await fetch('/blog/search.json');
      searchIndex = await response.json();
    } catch (error) {
      console.error('Failed to load search index:', error);
    }
  }

  // Debounced search function
  function debounceSearch(query: string) {
    const spinner = document.getElementById('search-spinner');
    const resultsDiv = document.getElementById('search-results');
    const noResultsDiv = document.getElementById('no-results');

    if (!query.trim()) {
      resultsDiv?.classList.add('hidden');
      noResultsDiv?.classList.add('hidden');
      return;
    }

    spinner?.classList.remove('hidden');

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      performSearch(query);
      spinner?.classList.add('hidden');
    }, 300); // 300ms debounce
  }

  // Perform search
  function performSearch(query: string) {
    const resultsDiv = document.getElementById('search-results');
    const noResultsDiv = document.getElementById('no-results');
    const resultsContainer = document.getElementById('results-container');
    const resultsCount = document.getElementById('results-count');

    const lowerQuery = query.toLowerCase();

    const results = searchIndex.filter(post => {
      return (
        post.title.toLowerCase().includes(lowerQuery) ||
        post.description.toLowerCase().includes(lowerQuery) ||
        post.tags.some(tag => tag.toLowerCase().includes(lowerQuery)) ||
        post.category.toLowerCase().includes(lowerQuery)
      );
    });

    if (results.length > 0) {
      resultsDiv?.classList.remove('hidden');
      noResultsDiv?.classList.add('hidden');

      if (resultsCount) {
        resultsCount.textContent = results.length.toString();
      }

      if (resultsContainer) {
        resultsContainer.innerHTML = results
          .map(
            post => `
          <a href="/blog/${post.slug}" class="block p-5 bg-glass border border-glass-border rounded-xl hover:border-white/20 transition-all">
            <h3 class="font-bold text-main mb-2 text-lg">${highlightMatch(post.title, query)}</h3>
            <p class="text-sm text-muted mb-4 opacity-80">${highlightMatch(post.description, query)}</p>
            <div class="flex gap-2">
              <span class="text-xs px-2 py-1 bg-glass border border-glass-border text-accent-light rounded-full">${post.category}</span>
              ${post.tags
                .slice(0, 2)
                .map(tag => `<span class="text-xs px-2 py-1 bg-glass-heavy border border-glass-border text-muted rounded">#${tag}</span>`)
                .join('')}
            </div>
          </a>
        `
          )
          .join('');
      }
    } else {
      resultsDiv?.classList.add('hidden');
      noResultsDiv?.classList.remove('hidden');
    }
  }

  // Highlight matching text
  function highlightMatch(text: string, query: string): string {
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark class="bg-accent-blue/30 text-accent-light px-1 rounded">$1</mark>');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadSearchIndex();

    const searchInput = document.getElementById('blog-search') as HTMLInputElement;
    searchInput?.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      debounceSearch(target.value);
    });

    // Save search query to URL
    searchInput?.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const url = new URL(window.location.href);
      if (target.value) {
        url.searchParams.set('q', target.value);
      } else {
        url.searchParams.delete('q');
      }
      window.history.replaceState({}, '', url.toString());
    });

    // Restore search query from URL
    const urlParams = new URLSearchParams(window.location.search);
    const savedQuery = urlParams.get('q');
    if (savedQuery && searchInput) {
      searchInput.value = savedQuery;
      debounceSearch(savedQuery);
    }
  });
</script>

<style>
  #blog-search:focus {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }
</style>
